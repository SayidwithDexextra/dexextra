CoreVault Redeploy / OrderBook Rewire — concise summary

Constraints
- CoreVault holds collateral; redeploy does not move funds.
- OrderBooks store vault address at init and cannot switch without a diamond cut or redeploy.
- FuturesMarketFactory may be immutable or admin-updatable re: vault target depending on version.

When a redeploy is justified
- Critical non-upgradeable bug, storage layout issue, chain migration, or security reset.
- Prefer config/address updates or small facets over full redeploys when possible.

Pre-deploy prerequisites
- Governance sign-off, comms + maintenance window; pause trading/withdrawals.
- Gather addresses: USDC (6 decimals), existing libraries (VaultAnalytics, PositionManager), LiquidationManager impl, CollateralHub (if used), FuturesMarketFactory, all OrderBooks + marketIds.
- Prepare configs/env: `Dexetrav5/deployments/{network}-deployment.json`, `Dexetrav5/config/contracts.js`, app/server envs.

Deploy + configure new CoreVault
- Deploy with (USDC, admin); link libraries.
- Configure: setLiquidationManager, set MMR params, grant roles (FACTORY_ROLE to factory, SETTLEMENT_ROLE to factory/settlement ops, ORDERBOOK_ROLE ± SETTLEMENT_ROLE to each OrderBook, EXTERNAL_CREDITOR_ROLE to CollateralHub if used).
- Register mappings: registerOrderBook(OB) and assignMarketToOrderBook(marketId, OB).

Factory alignment
- If factory supports updating vault, point it to the new CoreVault; else deploy a new factory targeting the new vault and grant roles.

OrderBook alignment (critical)
- Existing OrderBooks keep the old vault. Options:
  - Diamond cut: add an admin facet to set `s.vault` and upgrade every OrderBook.
  - Redeploy OrderBooks initialized with the new vault; re-register and re-assign market mappings on the new CoreVault.

Funds/data strategy
- Old CoreVault retains user funds. Either run legacy markets on old vault and new markets on new vault (dual-vault), or migrate: pause, snapshot, communicate, have users withdraw from old and deposit to new (or provide credit/claim flow).

Validation after cutover
- AccessControl: intended roles set.
- Market wiring: marketId → OrderBook on new vault; OrderBooks call the new vault.
- Liquidations/settlement: exercise isLiquidatable, updatePositionWithLiquidation, updateMarkPrice, settleMarket.
- App/backend: configs/envs use new addresses; no hardcoded old addresses.





